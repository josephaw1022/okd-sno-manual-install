worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

stream {
    # API Server (6443) - load balance across all masters
    upstream api_server {
        least_conn;
        server 192.168.1.10:6443 max_fails=3 fail_timeout=10s;
        server 192.168.1.13:6443 max_fails=3 fail_timeout=10s;
        server 192.168.1.12:6443 max_fails=3 fail_timeout=10s;
    }

    server {
        listen 6443;
        proxy_pass api_server;
        proxy_timeout 3s;
        proxy_connect_timeout 1s;
    }

    # Machine Config Server (22623) - load balance across all masters
    upstream machine_config {
        least_conn;
        server 192.168.1.10:22623 max_fails=3 fail_timeout=10s;
        server 192.168.1.13:22623 max_fails=3 fail_timeout=10s;
        server 192.168.1.12:22623 max_fails=3 fail_timeout=10s;
    }

    server {
        listen 22623;
        proxy_pass machine_config;
        proxy_timeout 3s;
        proxy_connect_timeout 1s;
    }

    # HTTP Ingress (80) - load balance across all masters
    upstream ingress_http {
        least_conn;
        server 192.168.1.10:80 max_fails=3 fail_timeout=10s;
        server 192.168.1.13:80 max_fails=3 fail_timeout=10s;
        server 192.168.1.12:80 max_fails=3 fail_timeout=10s;
    }

    server {
        listen 80;
        proxy_pass ingress_http;
        proxy_timeout 3s;
        proxy_connect_timeout 1s;
    }

    # HTTPS Ingress (443) - load balance across all masters
    upstream ingress_https {
        least_conn;
        server 192.168.1.10:443 max_fails=3 fail_timeout=10s;
        server 192.168.1.13:443 max_fails=3 fail_timeout=10s;
        server 192.168.1.12:443 max_fails=3 fail_timeout=10s;
    }

    server {
        listen 443;
        proxy_pass ingress_https;
        proxy_timeout 3s;
        proxy_connect_timeout 1s;
    }
}
