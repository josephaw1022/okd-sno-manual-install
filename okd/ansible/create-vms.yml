---
# Ansible playbook to create OKD VMs using libvirt (Agent-Based Installer)
# Usage: ansible-playbook -i inventory.yml create-vms.yml
#
# This creates 3 master nodes for the OKD cluster using a single agent ISO.
# No bootstrap VM needed - the agent installer handles bootstrapping internally.

- name: Create OKD VMs on libvirt host
  hosts: libvirt_hosts
  gather_facts: true
  vars:
    cluster_name: okd
    base_domain: kubesoar.com
    agent_iso: "agent.x86_64.iso"
    target_network: "192.168.1.0"

    # VM definitions for 3 master nodes
    # MAC addresses must match those in agent-config.yaml
    # master-0 is the rendezvous host and gets more memory for bootstrapping
    okd_vms:
      - name: "{{ cluster_name }}-master-0"
        mac: "52:54:00:00:00:10"
        ip: "192.168.1.10"
        memory_mb: 40960  # 40GB for rendezvous/bootstrap node
      - name: "{{ cluster_name }}-master-1"
        mac: "52:54:00:00:00:11"
        ip: "192.168.1.13"
        memory_mb: 20480  # 20GB
      - name: "{{ cluster_name }}-master-2"
        mac: "52:54:00:00:00:12"
        ip: "192.168.1.12"
        memory_mb: 20480  # 20GB

  tasks:
    - name: Ensure libvirt is running
      ansible.builtin.service:
        name: libvirtd
        state: started
        enabled: true

    - name: Get network interface for 192.168.1.x network
      ansible.builtin.shell:
        cmd: |
          ip -o addr show | grep '192.168.1\.' | awk '{print $2}' | head -1
      register: physical_interface
      changed_when: false

    - name: Fail if no interface found
      ansible.builtin.fail:
        msg: "Could not find network interface for {{ target_network }}. Check your network configuration."
      when: physical_interface.stdout == ""

    - name: Display detected interface
      ansible.builtin.debug:
        msg: "Using physical interface: {{ physical_interface.stdout }}"

    - name: Create VM disk images directory
      ansible.builtin.file:
        path: "{{ iso_dest_path }}"
        state: directory
        mode: '0755'

    - name: Create master VM disks
      ansible.builtin.command:
        cmd: >
          qemu-img create -f qcow2
          {{ iso_dest_path }}/{{ item.name }}.qcow2
          {{ vm_disk_size_gb }}G
        creates: "{{ iso_dest_path }}/{{ item.name }}.qcow2"
      loop: "{{ okd_vms }}"

    - name: Check if master VMs exist
      ansible.builtin.command:
        cmd: virsh dominfo {{ item.name }}
      register: master_exists
      failed_when: false
      changed_when: false
      loop: "{{ okd_vms }}"

    - name: Create master VMs with macvtap bridged networking
      ansible.builtin.shell:
        cmd: |
          virt-install \
            --name {{ item.item.name }} \
            --ram {{ item.item.memory_mb }} \
            --vcpus {{ vm_cpus }} \
            --disk path={{ iso_dest_path }}/{{ item.item.name }}.qcow2,format=qcow2,bus=virtio \
            --cdrom {{ iso_dest_path }}/{{ agent_iso }} \
            --network type=direct,source={{ physical_interface.stdout }},source_mode=bridge,mac={{ item.item.mac }} \
            --os-variant fedora-coreos-stable \
            --graphics vnc,listen=0.0.0.0 \
            --noautoconsole \
            --boot hd,cdrom
      loop: "{{ master_exists.results }}"
      when: item.rc != 0

    - name: Display VM information
      ansible.builtin.debug:
        msg:
          - "VMs created successfully!"
          - "Master 0 (rendezvous): {{ okd_vms[0].name }} - {{ okd_vms[0].ip }}"
          - "Master 1: {{ okd_vms[1].name }} - {{ okd_vms[1].ip }}"
          - "Master 2: {{ okd_vms[2].name }} - {{ okd_vms[2].ip }}"
          - ""
          - "All 3 nodes boot from the same agent ISO."
          - "Master-0 is the rendezvous host and will coordinate the install."
          - ""
          - "Next steps:"
          - "1. Ensure DNS records are configured for all nodes"
          - "2. Monitor install progress: make wait-install"
          - "3. Watch logs: make watch-bootstrap"
